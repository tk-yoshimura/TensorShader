using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.Connection1D {
    [TestClass]
    public class ConvolutionTest {
        [TestMethod]
        public void ReferenceTest() {
            int inchannels = 7, outchannels = 11, kwidth = 3, inwidth = 13;
            int outwidth = inwidth - kwidth + 1, batch = 2;

            float[] xval = (new float[inwidth * inchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] yval = (new float[outwidth * outchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[kwidth * outchannels * inchannels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Tensor xtensor = new Tensor(Shape.Map1D(inchannels, inwidth, batch), xval);
            Tensor ytensor = new Tensor(Shape.Map1D(outchannels, outwidth, batch), yval);
            Tensor wtensor = new Tensor(Shape.Kernel1D(inchannels, outchannels, kwidth), wval);

            ParameterField x = xtensor;
            ParameterField w = wtensor;
            VariableField y_actual = ytensor;

            Field y_expect = Convolution1D(x, w);
            Field err = Abs(y_expect - y_actual);

            (Flow flow, Parameters Parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] gx_actual = x.GradTensor.State;
            float[] gw_actual = w.GradTensor.State;

            AssertError.Tolerance(gw_expect, gw_actual, 1e-7f, 1e-5f, $"not equal gw");

            AssertError.Tolerance(gx_expect, gx_actual, 1e-7f, 1e-5f, $"not equal gx");
        }

        float[] gx_expect = new float[] {
            2.661230000e-02f, 2.648558000e-02f, 2.635886000e-02f, 2.623214000e-02f, 2.610542000e-02f,
            2.597870000e-02f, 2.585198000e-02f, 1.685486000e-02f, 1.672814000e-02f, 1.660142000e-02f,
            1.647470000e-02f, 1.634798000e-02f, 1.622126000e-02f, 1.609454000e-02f, 8.422183000e-02f,
            8.371748000e-02f, 8.321313000e-02f, 8.270878000e-02f, 8.220443000e-02f, 8.170008000e-02f,
            8.119573000e-02f, 4.804690000e-02f, 4.766927000e-02f, 4.729164000e-02f, 4.691401000e-02f,
            4.653638000e-02f, 4.615875000e-02f, 4.578112000e-02f, 1.466059100e-01f, 1.455997400e-01f,
            1.445935700e-01f, 1.435874000e-01f, 1.425812300e-01f, 1.415750600e-01f, 1.405688900e-01f,
            7.923894000e-02f, 7.861040000e-02f, 7.798186000e-02f, 7.735332000e-02f, 7.672478000e-02f,
            7.609624000e-02f, 7.546770000e-02f, 2.089899900e-01f, 2.074820000e-01f, 2.059740100e-01f,
            2.044660200e-01f, 2.029580300e-01f, 2.014500400e-01f, 1.999420500e-01f, 1.104309800e-01f,
            1.095515300e-01f, 1.086720800e-01f, 1.077926300e-01f, 1.069131800e-01f, 1.060337300e-01f,
            1.051542800e-01f, 2.713740700e-01f, 2.693642600e-01f, 2.673544500e-01f, 2.653446400e-01f,
            2.633348300e-01f, 2.613250200e-01f, 2.593152100e-01f, 1.416230200e-01f, 1.404926600e-01f,
            1.393623000e-01f, 1.382319400e-01f, 1.371015800e-01f, 1.359712200e-01f, 1.348408600e-01f,
            3.337581500e-01f, 3.312465200e-01f, 3.287348900e-01f, 3.262232600e-01f, 3.237116300e-01f,
            3.212000000e-01f, 3.186883700e-01f, 1.728150600e-01f, 1.714337900e-01f, 1.700525200e-01f,
            1.686712500e-01f, 1.672899800e-01f, 1.659087100e-01f, 1.645274400e-01f, 6.645727000e-02f,
            6.507600000e-02f, 6.369473000e-02f, 6.231346000e-02f, 6.093219000e-02f, 5.955092000e-02f,
            5.816965000e-02f, 3.667385150e-01f, 3.649203800e-01f, 3.631022450e-01f, 3.612841100e-01f,
            3.594659750e-01f, 3.576478400e-01f, 3.558297050e-01f, 2.267421200e-01f, 2.249239850e-01f,
            2.231058500e-01f, 2.212877150e-01f, 2.194695800e-01f, 2.176514450e-01f, 2.158333100e-01f,
            5.039963500e-01f, 5.001091700e-01f, 4.962219900e-01f, 4.923348100e-01f, 4.884476300e-01f,
            4.845604500e-01f, 4.806732700e-01f, 2.579341600e-01f, 2.558651150e-01f, 2.537960700e-01f,
            2.517270250e-01f, 2.496579800e-01f, 2.475889350e-01f, 2.455198900e-01f, 5.663804300e-01f,
            5.619914300e-01f, 5.576024300e-01f, 5.532134300e-01f, 5.488244300e-01f, 5.444354300e-01f,
            5.400464300e-01f, 2.891262000e-01f, 2.868062450e-01f, 2.844862900e-01f, 2.821663350e-01f,
            2.798463800e-01f, 2.775264250e-01f, 2.752064700e-01f, 6.287645100e-01f, 6.238736900e-01f,
            6.189828700e-01f, 6.140920500e-01f, 6.092012300e-01f, 6.043104100e-01f, 5.994195900e-01f,
            3.203182400e-01f, 3.177473750e-01f, 3.151765100e-01f, 3.126056450e-01f, 3.100347800e-01f,
            3.074639150e-01f, 3.048930500e-01f, 6.911485900e-01f, 6.857559500e-01f, 6.803633100e-01f,
            6.749706700e-01f, 6.695780300e-01f, 6.641853900e-01f, 6.587927500e-01f, 3.515102800e-01f,
            3.486885050e-01f, 3.458667300e-01f, 3.430449550e-01f, 3.402231800e-01f, 3.374014050e-01f,
            3.345796300e-01f, 7.535326700e-01f, 7.476382100e-01f, 7.417437500e-01f, 7.358492900e-01f,
            7.299548300e-01f, 7.240603700e-01f, 7.181659100e-01f, 3.827023200e-01f, 3.796296350e-01f,
            3.765569500e-01f, 3.734842650e-01f, 3.704115800e-01f, 3.673388950e-01f, 3.642662100e-01f,
            1.461055750e-01f, 1.430328900e-01f, 1.399602050e-01f, 1.368875200e-01f, 1.338148350e-01f,
            1.307421500e-01f, 1.276694650e-01f,
        };

        float[] gw_expect = new float[] {
            2.860253200e-01f, 2.886286600e-01f, 2.912320000e-01f, 2.938353400e-01f, 2.964386800e-01f,
            2.990420200e-01f, 3.016453600e-01f, 2.675477980e-01f, 2.699794960e-01f, 2.724111940e-01f,
            2.748428920e-01f, 2.772745900e-01f, 2.797062880e-01f, 2.821379860e-01f, 2.490702760e-01f,
            2.513303320e-01f, 2.535903880e-01f, 2.558504440e-01f, 2.581105000e-01f, 2.603705560e-01f,
            2.626306120e-01f, 2.305927540e-01f, 2.326811680e-01f, 2.347695820e-01f, 2.368579960e-01f,
            2.389464100e-01f, 2.410348240e-01f, 2.431232380e-01f, 2.121152320e-01f, 2.140320040e-01f,
            2.159487760e-01f, 2.178655480e-01f, 2.197823200e-01f, 2.216990920e-01f, 2.236158640e-01f,
            1.936377100e-01f, 1.953828400e-01f, 1.971279700e-01f, 1.988731000e-01f, 2.006182300e-01f,
            2.023633600e-01f, 2.041084900e-01f, 1.751601880e-01f, 1.767336760e-01f, 1.783071640e-01f,
            1.798806520e-01f, 1.814541400e-01f, 1.830276280e-01f, 1.846011160e-01f, 1.566826660e-01f,
            1.580845120e-01f, 1.594863580e-01f, 1.608882040e-01f, 1.622900500e-01f, 1.636918960e-01f,
            1.650937420e-01f, 1.382051440e-01f, 1.394353480e-01f, 1.406655520e-01f, 1.418957560e-01f,
            1.431259600e-01f, 1.443561640e-01f, 1.455863680e-01f, 1.197276220e-01f, 1.207861840e-01f,
            1.218447460e-01f, 1.229033080e-01f, 1.239618700e-01f, 1.250204320e-01f, 1.260789940e-01f,
            1.012501000e-01f, 1.021370200e-01f, 1.030239400e-01f, 1.039108600e-01f, 1.047977800e-01f,
            1.056847000e-01f, 1.065716200e-01f, 3.042487000e-01f, 3.068520400e-01f, 3.094553800e-01f,
            3.120587200e-01f, 3.146620600e-01f, 3.172654000e-01f, 3.198687400e-01f, 2.845696840e-01f,
            2.870013820e-01f, 2.894330800e-01f, 2.918647780e-01f, 2.942964760e-01f, 2.967281740e-01f,
            2.991598720e-01f, 2.648906680e-01f, 2.671507240e-01f, 2.694107800e-01f, 2.716708360e-01f,
            2.739308920e-01f, 2.761909480e-01f, 2.784510040e-01f, 2.452116520e-01f, 2.473000660e-01f,
            2.493884800e-01f, 2.514768940e-01f, 2.535653080e-01f, 2.556537220e-01f, 2.577421360e-01f,
            2.255326360e-01f, 2.274494080e-01f, 2.293661800e-01f, 2.312829520e-01f, 2.331997240e-01f,
            2.351164960e-01f, 2.370332680e-01f, 2.058536200e-01f, 2.075987500e-01f, 2.093438800e-01f,
            2.110890100e-01f, 2.128341400e-01f, 2.145792700e-01f, 2.163244000e-01f, 1.861746040e-01f,
            1.877480920e-01f, 1.893215800e-01f, 1.908950680e-01f, 1.924685560e-01f, 1.940420440e-01f,
            1.956155320e-01f, 1.664955880e-01f, 1.678974340e-01f, 1.692992800e-01f, 1.707011260e-01f,
            1.721029720e-01f, 1.735048180e-01f, 1.749066640e-01f, 1.468165720e-01f, 1.480467760e-01f,
            1.492769800e-01f, 1.505071840e-01f, 1.517373880e-01f, 1.529675920e-01f, 1.541977960e-01f,
            1.271375560e-01f, 1.281961180e-01f, 1.292546800e-01f, 1.303132420e-01f, 1.313718040e-01f,
            1.324303660e-01f, 1.334889280e-01f, 1.074585400e-01f, 1.083454600e-01f, 1.092323800e-01f,
            1.101193000e-01f, 1.110062200e-01f, 1.118931400e-01f, 1.127800600e-01f, 3.224720800e-01f,
            3.250754200e-01f, 3.276787600e-01f, 3.302821000e-01f, 3.328854400e-01f, 3.354887800e-01f,
            3.380921200e-01f, 3.015915700e-01f, 3.040232680e-01f, 3.064549660e-01f, 3.088866640e-01f,
            3.113183620e-01f, 3.137500600e-01f, 3.161817580e-01f, 2.807110600e-01f, 2.829711160e-01f,
            2.852311720e-01f, 2.874912280e-01f, 2.897512840e-01f, 2.920113400e-01f, 2.942713960e-01f,
            2.598305500e-01f, 2.619189640e-01f, 2.640073780e-01f, 2.660957920e-01f, 2.681842060e-01f,
            2.702726200e-01f, 2.723610340e-01f, 2.389500400e-01f, 2.408668120e-01f, 2.427835840e-01f,
            2.447003560e-01f, 2.466171280e-01f, 2.485339000e-01f, 2.504506720e-01f, 2.180695300e-01f,
            2.198146600e-01f, 2.215597900e-01f, 2.233049200e-01f, 2.250500500e-01f, 2.267951800e-01f,
            2.285403100e-01f, 1.971890200e-01f, 1.987625080e-01f, 2.003359960e-01f, 2.019094840e-01f,
            2.034829720e-01f, 2.050564600e-01f, 2.066299480e-01f, 1.763085100e-01f, 1.777103560e-01f,
            1.791122020e-01f, 1.805140480e-01f, 1.819158940e-01f, 1.833177400e-01f, 1.847195860e-01f,
            1.554280000e-01f, 1.566582040e-01f, 1.578884080e-01f, 1.591186120e-01f, 1.603488160e-01f,
            1.615790200e-01f, 1.628092240e-01f, 1.345474900e-01f, 1.356060520e-01f, 1.366646140e-01f,
            1.377231760e-01f, 1.387817380e-01f, 1.398403000e-01f, 1.408988620e-01f, 1.136669800e-01f,
            1.145539000e-01f, 1.154408200e-01f, 1.163277400e-01f, 1.172146600e-01f, 1.181015800e-01f,
            1.189885000e-01f,
        };
    }
}
