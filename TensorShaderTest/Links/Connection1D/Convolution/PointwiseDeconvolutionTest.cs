using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.Connection1D {
    [TestClass]
    public class PointwisewiseDeconvolutionTest {
        [TestMethod]
        public void ReferenceTest() {
            int inchannels = 7, outchannels = 11, width = 13, batch = 2;

            float[] xval = (new float[width * inchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] yval = (new float[width * outchannels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[outchannels * inchannels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            ParameterField y = new Tensor(Shape.Map1D(outchannels, width, batch), yval);
            ParameterField w = new Tensor(Shape.Kernel0D(inchannels, outchannels), wval);
            VariableField x_actual = new Tensor(Shape.Map1D(inchannels, width, batch), xval);

            Field x_expect = PointwiseDeconvolution1D(y, w);
            Field err = Abs(x_expect - x_actual);

            (Flow flow, Parameters parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] gy_actual = y.GradState;
            float[] gw_actual = w.GradState;

            AssertError.Tolerance(gw_expect, gw_actual, 1e-7f, 1e-5f, $"not equal gw");

            AssertError.Tolerance(gy_expect, gy_actual, 1e-7f, 1e-5f, $"not equal gy");
        }

        float[] gy_expect = new float[] {
            -8.2894000e-04f,  -7.4662000e-04f,  -6.6430000e-04f,  -5.8198000e-04f,  -4.9966000e-04f,  -4.1734000e-04f,  -3.3502000e-04f,  -2.5270000e-04f,  -1.7038000e-04f,  -8.8060000e-05f,  -5.7400000e-06f,
            -2.0529740e-03f,  -1.8529560e-03f,  -1.6529380e-03f,  -1.4529200e-03f,  -1.2529020e-03f,  -1.0528840e-03f,  -8.5286600e-04f,  -6.5284800e-04f,  -4.5283000e-04f,  -2.5281200e-04f,  -5.2794000e-05f,
            -3.2770080e-03f,  -2.9592920e-03f,  -2.6415760e-03f,  -2.3238600e-03f,  -2.0061440e-03f,  -1.6884280e-03f,  -1.3707120e-03f,  -1.0529960e-03f,  -7.3528000e-04f,  -4.1756400e-04f,  -9.9848000e-05f,
            -4.5010420e-03f,  -4.0656280e-03f,  -3.6302140e-03f,  -3.1948000e-03f,  -2.7593860e-03f,  -2.3239720e-03f,  -1.8885580e-03f,  -1.4531440e-03f,  -1.0177300e-03f,  -5.8231600e-04f,  -1.4690200e-04f,
            -5.7250760e-03f,  -5.1719640e-03f,  -4.6188520e-03f,  -4.0657400e-03f,  -3.5126280e-03f,  -2.9595160e-03f,  -2.4064040e-03f,  -1.8532920e-03f,  -1.3001800e-03f,  -7.4706800e-04f,  -1.9395600e-04f,
            -6.9491100e-03f,  -6.2783000e-03f,  -5.6074900e-03f,  -4.9366800e-03f,  -4.2658700e-03f,  -3.5950600e-03f,  -2.9242500e-03f,  -2.2534400e-03f,  -1.5826300e-03f,  -9.1182000e-04f,  -2.4101000e-04f,
            -8.1731440e-03f,  -7.3846360e-03f,  -6.5961280e-03f,  -5.8076200e-03f,  -5.0191120e-03f,  -4.2306040e-03f,  -3.4420960e-03f,  -2.6535880e-03f,  -1.8650800e-03f,  -1.0765720e-03f,  -2.8806400e-04f,
            -9.3971780e-03f,  -8.4909720e-03f,  -7.5847660e-03f,  -6.6785600e-03f,  -5.7723540e-03f,  -4.8661480e-03f,  -3.9599420e-03f,  -3.0537360e-03f,  -2.1475300e-03f,  -1.2413240e-03f,  -3.3511800e-04f,
            -1.0621212e-02f,  -9.5973080e-03f,  -8.5734040e-03f,  -7.5495000e-03f,  -6.5255960e-03f,  -5.5016920e-03f,  -4.4777880e-03f,  -3.4538840e-03f,  -2.4299800e-03f,  -1.4060760e-03f,  -3.8217200e-04f,
            -1.1845246e-02f,  -1.0703644e-02f,  -9.5620420e-03f,  -8.4204400e-03f,  -7.2788380e-03f,  -6.1372360e-03f,  -4.9956340e-03f,  -3.8540320e-03f,  -2.7124300e-03f,  -1.5708280e-03f,  -4.2922600e-04f,
            -1.3069280e-02f,  -1.1809980e-02f,  -1.0550680e-02f,  -9.2913800e-03f,  -8.0320800e-03f,  -6.7727800e-03f,  -5.5134800e-03f,  -4.2541800e-03f,  -2.9948800e-03f,  -1.7355800e-03f,  -4.7628000e-04f,
            -1.4293314e-02f,  -1.2916316e-02f,  -1.1539318e-02f,  -1.0162320e-02f,  -8.7853220e-03f,  -7.4083240e-03f,  -6.0313260e-03f,  -4.6543280e-03f,  -3.2773300e-03f,  -1.9003320e-03f,  -5.2333400e-04f,
            -1.5517348e-02f,  -1.4022652e-02f,  -1.2527956e-02f,  -1.1033260e-02f,  -9.5385640e-03f,  -8.0438680e-03f,  -6.5491720e-03f,  -5.0544760e-03f,  -3.5597800e-03f,  -2.0650840e-03f,  -5.7038800e-04f,
            -1.6741382e-02f,  -1.5128988e-02f,  -1.3516594e-02f,  -1.1904200e-02f,  -1.0291806e-02f,  -8.6794120e-03f,  -7.0670180e-03f,  -5.4546240e-03f,  -3.8422300e-03f,  -2.2298360e-03f,  -6.1744200e-04f,
            -1.7965416e-02f,  -1.6235324e-02f,  -1.4505232e-02f,  -1.2775140e-02f,  -1.1045048e-02f,  -9.3149560e-03f,  -7.5848640e-03f,  -5.8547720e-03f,  -4.1246800e-03f,  -2.3945880e-03f,  -6.6449600e-04f,
            -1.9189450e-02f,  -1.7341660e-02f,  -1.5493870e-02f,  -1.3646080e-02f,  -1.1798290e-02f,  -9.9505000e-03f,  -8.1027100e-03f,  -6.2549200e-03f,  -4.4071300e-03f,  -2.5593400e-03f,  -7.1155000e-04f,
            -2.0413484e-02f,  -1.8447996e-02f,  -1.6482508e-02f,  -1.4517020e-02f,  -1.2551532e-02f,  -1.0586044e-02f,  -8.6205560e-03f,  -6.6550680e-03f,  -4.6895800e-03f,  -2.7240920e-03f,  -7.5860400e-04f,
            -2.1637518e-02f,  -1.9554332e-02f,  -1.7471146e-02f,  -1.5387960e-02f,  -1.3304774e-02f,  -1.1221588e-02f,  -9.1384020e-03f,  -7.0552160e-03f,  -4.9720300e-03f,  -2.8888440e-03f,  -8.0565800e-04f,
            -2.2861552e-02f,  -2.0660668e-02f,  -1.8459784e-02f,  -1.6258900e-02f,  -1.4058016e-02f,  -1.1857132e-02f,  -9.6562480e-03f,  -7.4553640e-03f,  -5.2544800e-03f,  -3.0535960e-03f,  -8.5271200e-04f,
            -2.4085586e-02f,  -2.1767004e-02f,  -1.9448422e-02f,  -1.7129840e-02f,  -1.4811258e-02f,  -1.2492676e-02f,  -1.0174094e-02f,  -7.8555120e-03f,  -5.5369300e-03f,  -3.2183480e-03f,  -8.9976600e-04f,
            -2.5309620e-02f,  -2.2873340e-02f,  -2.0437060e-02f,  -1.8000780e-02f,  -1.5564500e-02f,  -1.3128220e-02f,  -1.0691940e-02f,  -8.2556600e-03f,  -5.8193800e-03f,  -3.3831000e-03f,  -9.4682000e-04f,
            -2.6533654e-02f,  -2.3979676e-02f,  -2.1425698e-02f,  -1.8871720e-02f,  -1.6317742e-02f,  -1.3763764e-02f,  -1.1209786e-02f,  -8.6558080e-03f,  -6.1018300e-03f,  -3.5478520e-03f,  -9.9387400e-04f,
            -2.7757688e-02f,  -2.5086012e-02f,  -2.2414336e-02f,  -1.9742660e-02f,  -1.7070984e-02f,  -1.4399308e-02f,  -1.1727632e-02f,  -9.0559560e-03f,  -6.3842800e-03f,  -3.7126040e-03f,  -1.0409280e-03f,
            -2.8981722e-02f,  -2.6192348e-02f,  -2.3402974e-02f,  -2.0613600e-02f,  -1.7824226e-02f,  -1.5034852e-02f,  -1.2245478e-02f,  -9.4561040e-03f,  -6.6667300e-03f,  -3.8773560e-03f,  -1.0879820e-03f,
            -3.0205756e-02f,  -2.7298684e-02f,  -2.4391612e-02f,  -2.1484540e-02f,  -1.8577468e-02f,  -1.5670396e-02f,  -1.2763324e-02f,  -9.8562520e-03f,  -6.9491800e-03f,  -4.0421080e-03f,  -1.1350360e-03f,
            -3.1429790e-02f,  -2.8405020e-02f,  -2.5380250e-02f,  -2.2355480e-02f,  -1.9330710e-02f,  -1.6305940e-02f,  -1.3281170e-02f,  -1.0256400e-02f,  -7.2316300e-03f,  -4.2068600e-03f,  -1.1820900e-03f,
        };

        float[] gw_expect = new float[] {
            -1.1861135e-01f,  -1.2973675e-01f,  -1.4086215e-01f,  -1.5198755e-01f,  -1.6311295e-01f,  -1.7423835e-01f,  -1.8536375e-01f,
            -1.1923542e-01f,  -1.3042757e-01f,  -1.4161972e-01f,  -1.5281188e-01f,  -1.6400404e-01f,  -1.7519619e-01f,  -1.8638834e-01f,
            -1.1985948e-01f,  -1.3111839e-01f,  -1.4237730e-01f,  -1.5363621e-01f,  -1.6489512e-01f,  -1.7615403e-01f,  -1.8741294e-01f,
            -1.2048355e-01f,  -1.3180921e-01f,  -1.4313487e-01f,  -1.5446054e-01f,  -1.6578620e-01f,  -1.7711187e-01f,  -1.8843753e-01f,
            -1.2110761e-01f,  -1.3250003e-01f,  -1.4389245e-01f,  -1.5528487e-01f,  -1.6667729e-01f,  -1.7806971e-01f,  -1.8946213e-01f,
            -1.2173167e-01f,  -1.3319085e-01f,  -1.4465002e-01f,  -1.5610920e-01f,  -1.6756837e-01f,  -1.7902755e-01f,  -1.9048672e-01f,
            -1.2235574e-01f,  -1.3388167e-01f,  -1.4540760e-01f,  -1.5693353e-01f,  -1.6845946e-01f,  -1.7998539e-01f,  -1.9151132e-01f,
            -1.2297981e-01f,  -1.3457249e-01f,  -1.4616517e-01f,  -1.5775786e-01f,  -1.6935055e-01f,  -1.8094323e-01f,  -1.9253591e-01f,
            -1.2360387e-01f,  -1.3526331e-01f,  -1.4692275e-01f,  -1.5858219e-01f,  -1.7024163e-01f,  -1.8190107e-01f,  -1.9356051e-01f,
            -1.2422794e-01f,  -1.3595413e-01f,  -1.4768032e-01f,  -1.5940652e-01f,  -1.7113271e-01f,  -1.8285891e-01f,  -1.9458510e-01f,
            -1.2485200e-01f,  -1.3664495e-01f,  -1.4843790e-01f,  -1.6023085e-01f,  -1.7202380e-01f,  -1.8381675e-01f,  -1.9560970e-01f,
        };
    }
}
