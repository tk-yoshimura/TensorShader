using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.ArrayManipulation {
    [TestClass]
    public class ReshapeTest {
        [TestMethod]
        public void ReferenceTest() {
            int s0 = 3, s1 = 6, s2 = 4, s3 = 5;

            float[] xval = (new float[s0 * s1 * s2 * s3]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] yval = (new float[s3 * s2 * s1 * s0]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Tensor xtensor = new Tensor(new Shape(ShapeType.Map, s0, s1, s2, s3), xval);
            Tensor ytensor = new Tensor(new Shape(ShapeType.Map, s3 * s2, s1 * s0), yval);

            ParameterField x = xtensor;
            VariableField y_actual = ytensor;

            Field y_expect = Reshape(x, ytensor.Shape);
            Field err = Abs(y_expect - y_actual);

            (Flow flow, Parameters Parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] gx_actual = x.GradTensor.State;

            AssertError.Tolerance(gx_expect, gx_actual, 1e-7f, 1e-5f, $"not equal gx");
        }

        float[] gx_expect = {
            -3.5900e-01f, -3.5700e-01f, -3.5500e-01f, -3.5300e-01f, -3.5100e-01f,
            -3.4900e-01f, -3.4700e-01f, -3.4500e-01f, -3.4300e-01f, -3.4100e-01f,
            -3.3900e-01f, -3.3700e-01f, -3.3500e-01f, -3.3300e-01f, -3.3100e-01f,
            -3.2900e-01f, -3.2700e-01f, -3.2500e-01f, -3.2300e-01f, -3.2100e-01f,
            -3.1900e-01f, -3.1700e-01f, -3.1500e-01f, -3.1300e-01f, -3.1100e-01f,
            -3.0900e-01f, -3.0700e-01f, -3.0500e-01f, -3.0300e-01f, -3.0100e-01f,
            -2.9900e-01f, -2.9700e-01f, -2.9500e-01f, -2.9300e-01f, -2.9100e-01f,
            -2.8900e-01f, -2.8700e-01f, -2.8500e-01f, -2.8300e-01f, -2.8100e-01f,
            -2.7900e-01f, -2.7700e-01f, -2.7500e-01f, -2.7300e-01f, -2.7100e-01f,
            -2.6900e-01f, -2.6700e-01f, -2.6500e-01f, -2.6300e-01f, -2.6100e-01f,
            -2.5900e-01f, -2.5700e-01f, -2.5500e-01f, -2.5300e-01f, -2.5100e-01f,
            -2.4900e-01f, -2.4700e-01f, -2.4500e-01f, -2.4300e-01f, -2.4100e-01f,
            -2.3900e-01f, -2.3700e-01f, -2.3500e-01f, -2.3300e-01f, -2.3100e-01f,
            -2.2900e-01f, -2.2700e-01f, -2.2500e-01f, -2.2300e-01f, -2.2100e-01f,
            -2.1900e-01f, -2.1700e-01f, -2.1500e-01f, -2.1300e-01f, -2.1100e-01f,
            -2.0900e-01f, -2.0700e-01f, -2.0500e-01f, -2.0300e-01f, -2.0100e-01f,
            -1.9900e-01f, -1.9700e-01f, -1.9500e-01f, -1.9300e-01f, -1.9100e-01f,
            -1.8900e-01f, -1.8700e-01f, -1.8500e-01f, -1.8300e-01f, -1.8100e-01f,
            -1.7900e-01f, -1.7700e-01f, -1.7500e-01f, -1.7300e-01f, -1.7100e-01f,
            -1.6900e-01f, -1.6700e-01f, -1.6500e-01f, -1.6300e-01f, -1.6100e-01f,
            -1.5900e-01f, -1.5700e-01f, -1.5500e-01f, -1.5300e-01f, -1.5100e-01f,
            -1.4900e-01f, -1.4700e-01f, -1.4500e-01f, -1.4300e-01f, -1.4100e-01f,
            -1.3900e-01f, -1.3700e-01f, -1.3500e-01f, -1.3300e-01f, -1.3100e-01f,
            -1.2900e-01f, -1.2700e-01f, -1.2500e-01f, -1.2300e-01f, -1.2100e-01f,
            -1.1900e-01f, -1.1700e-01f, -1.1500e-01f, -1.1300e-01f, -1.1100e-01f,
            -1.0900e-01f, -1.0700e-01f, -1.0500e-01f, -1.0300e-01f, -1.0100e-01f,
            -9.9000e-02f, -9.7000e-02f, -9.5000e-02f, -9.3000e-02f, -9.1000e-02f,
            -8.9000e-02f, -8.7000e-02f, -8.5000e-02f, -8.3000e-02f, -8.1000e-02f,
            -7.9000e-02f, -7.7000e-02f, -7.5000e-02f, -7.3000e-02f, -7.1000e-02f,
            -6.9000e-02f, -6.7000e-02f, -6.5000e-02f, -6.3000e-02f, -6.1000e-02f,
            -5.9000e-02f, -5.7000e-02f, -5.5000e-02f, -5.3000e-02f, -5.1000e-02f,
            -4.9000e-02f, -4.7000e-02f, -4.5000e-02f, -4.3000e-02f, -4.1000e-02f,
            -3.9000e-02f, -3.7000e-02f, -3.5000e-02f, -3.3000e-02f, -3.1000e-02f,
            -2.9000e-02f, -2.7000e-02f, -2.5000e-02f, -2.3000e-02f, -2.1000e-02f,
            -1.9000e-02f, -1.7000e-02f, -1.5000e-02f, -1.3000e-02f, -1.1000e-02f,
            -9.0000e-03f, -7.0000e-03f, -5.0000e-03f, -3.0000e-03f, -1.0000e-03f,
            1.0000e-03f, 3.0000e-03f, 5.0000e-03f, 7.0000e-03f, 9.0000e-03f,
            1.1000e-02f, 1.3000e-02f, 1.5000e-02f, 1.7000e-02f, 1.9000e-02f,
            2.1000e-02f, 2.3000e-02f, 2.5000e-02f, 2.7000e-02f, 2.9000e-02f,
            3.1000e-02f, 3.3000e-02f, 3.5000e-02f, 3.7000e-02f, 3.9000e-02f,
            4.1000e-02f, 4.3000e-02f, 4.5000e-02f, 4.7000e-02f, 4.9000e-02f,
            5.1000e-02f, 5.3000e-02f, 5.5000e-02f, 5.7000e-02f, 5.9000e-02f,
            6.1000e-02f, 6.3000e-02f, 6.5000e-02f, 6.7000e-02f, 6.9000e-02f,
            7.1000e-02f, 7.3000e-02f, 7.5000e-02f, 7.7000e-02f, 7.9000e-02f,
            8.1000e-02f, 8.3000e-02f, 8.5000e-02f, 8.7000e-02f, 8.9000e-02f,
            9.1000e-02f, 9.3000e-02f, 9.5000e-02f, 9.7000e-02f, 9.9000e-02f,
            1.0100e-01f, 1.0300e-01f, 1.0500e-01f, 1.0700e-01f, 1.0900e-01f,
            1.1100e-01f, 1.1300e-01f, 1.1500e-01f, 1.1700e-01f, 1.1900e-01f,
            1.2100e-01f, 1.2300e-01f, 1.2500e-01f, 1.2700e-01f, 1.2900e-01f,
            1.3100e-01f, 1.3300e-01f, 1.3500e-01f, 1.3700e-01f, 1.3900e-01f,
            1.4100e-01f, 1.4300e-01f, 1.4500e-01f, 1.4700e-01f, 1.4900e-01f,
            1.5100e-01f, 1.5300e-01f, 1.5500e-01f, 1.5700e-01f, 1.5900e-01f,
            1.6100e-01f, 1.6300e-01f, 1.6500e-01f, 1.6700e-01f, 1.6900e-01f,
            1.7100e-01f, 1.7300e-01f, 1.7500e-01f, 1.7700e-01f, 1.7900e-01f,
            1.8100e-01f, 1.8300e-01f, 1.8500e-01f, 1.8700e-01f, 1.8900e-01f,
            1.9100e-01f, 1.9300e-01f, 1.9500e-01f, 1.9700e-01f, 1.9900e-01f,
            2.0100e-01f, 2.0300e-01f, 2.0500e-01f, 2.0700e-01f, 2.0900e-01f,
            2.1100e-01f, 2.1300e-01f, 2.1500e-01f, 2.1700e-01f, 2.1900e-01f,
            2.2100e-01f, 2.2300e-01f, 2.2500e-01f, 2.2700e-01f, 2.2900e-01f,
            2.3100e-01f, 2.3300e-01f, 2.3500e-01f, 2.3700e-01f, 2.3900e-01f,
            2.4100e-01f, 2.4300e-01f, 2.4500e-01f, 2.4700e-01f, 2.4900e-01f,
            2.5100e-01f, 2.5300e-01f, 2.5500e-01f, 2.5700e-01f, 2.5900e-01f,
            2.6100e-01f, 2.6300e-01f, 2.6500e-01f, 2.6700e-01f, 2.6900e-01f,
            2.7100e-01f, 2.7300e-01f, 2.7500e-01f, 2.7700e-01f, 2.7900e-01f,
            2.8100e-01f, 2.8300e-01f, 2.8500e-01f, 2.8700e-01f, 2.8900e-01f,
            2.9100e-01f, 2.9300e-01f, 2.9500e-01f, 2.9700e-01f, 2.9900e-01f,
            3.0100e-01f, 3.0300e-01f, 3.0500e-01f, 3.0700e-01f, 3.0900e-01f,
            3.1100e-01f, 3.1300e-01f, 3.1500e-01f, 3.1700e-01f, 3.1900e-01f,
            3.2100e-01f, 3.2300e-01f, 3.2500e-01f, 3.2700e-01f, 3.2900e-01f,
            3.3100e-01f, 3.3300e-01f, 3.3500e-01f, 3.3700e-01f, 3.3900e-01f,
            3.4100e-01f, 3.4300e-01f, 3.4500e-01f, 3.4700e-01f, 3.4900e-01f,
            3.5100e-01f, 3.5300e-01f, 3.5500e-01f, 3.5700e-01f, 3.5900e-01f,
        };
    }
}
