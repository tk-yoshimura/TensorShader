using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.Connection3D {
    [TestClass]
    public class ChannelwiseDeconvolutionTest {
        [TestMethod]
        public void ReferenceTest() {
            int channels = 2, kwidth = 3, kheight = 5, kdepth = 7, stride = 2, inwidth = 13, inheight = 12, indepth = 11;
            int outwidth = (inwidth - kwidth) / stride + 1, outheight = (inheight - kheight) / stride + 1, outdepth = (indepth - kdepth) / stride + 1, batch = 2;

            float[] xval = (new float[inwidth * inheight * indepth * channels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] yval = (new float[outwidth * outheight * outdepth * channels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[kwidth * kheight * kdepth * channels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Tensor xtensor = new Tensor(Shape.Map3D(channels, inwidth, inheight, indepth, batch), xval);
            Tensor ytensor = new Tensor(Shape.Map3D(channels, outwidth, outheight, outdepth, batch), yval);
            Tensor wtensor = new Tensor(Shape.Kernel3D(channels, 1, kwidth, kheight, kdepth), wval);

            VariableField x_actual = xtensor;
            ParameterField w = wtensor;
            ParameterField y = ytensor;

            Field x_expect = ChannelwiseDeconvolution3D(y, w, stride, Shape.Map3D(channels, inwidth, inheight, indepth, batch));
            Field err = Abs(x_expect - x_actual);
            OutputNode err_node = err.Value.Save();

            (Flow flow, Parameters Parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] err_actual = err_node.Tensor.State;
            float[] gy_actual = y.GradTensor.State;
            float[] gw_actual = w.GradTensor.State;

            AssertError.Tolerance(gw_expect, gw_actual, 1e-7f, 1e-5f, $"not equal gw");

            AssertError.Tolerance(gy_expect, gy_actual, 1e-7f, 1e-5f, $"not equal gy");
        }

        float[] gy_expect = new float[] {
            -6.724420442e+00f,  -6.629667644e+00f,  -6.698296070e+00f,  -6.602887760e+00f,  -6.725820320e+00f,  -6.630274160e+00f,
            -6.753344570e+00f,  -6.657660560e+00f,  -6.780868820e+00f,  -6.685046960e+00f,  -6.882995222e+00f,  -6.787130804e+00f,
            -7.151903432e+00f,  -7.052150048e+00f,  -7.084548080e+00f,  -6.984321200e+00f,  -7.106376680e+00f,  -7.006106000e+00f,
            -7.128205280e+00f,  -7.027890800e+00f,  -7.150033880e+00f,  -7.049675600e+00f,  -7.289102744e+00f,  -7.188570560e+00f,
            -7.647401384e+00f,  -7.543327040e+00f,  -7.560419120e+00f,  -7.456157840e+00f,  -7.582089320e+00f,  -7.477784240e+00f,
            -7.603759520e+00f,  -7.499410640e+00f,  -7.625429720e+00f,  -7.521037040e+00f,  -7.783944632e+00f,  -7.679094368e+00f,
            -8.277005402e+00f,  -8.168268764e+00f,  -8.208667970e+00f,  -8.099879360e+00f,  -8.235796220e+00f,  -8.126869760e+00f,
            -8.262924470e+00f,  -8.153860160e+00f,  -8.290052720e+00f,  -8.180850560e+00f,  -8.434035062e+00f,  -8.324194004e+00f,
            -1.339371193e+01f,  -1.323435679e+01f,  -1.331295989e+01f,  -1.315322150e+01f,  -1.333708304e+01f,  -1.317724442e+01f,
            -1.336120619e+01f,  -1.320126734e+01f,  -1.338532934e+01f,  -1.322529026e+01f,  -1.354096512e+01f,  -1.338065707e+01f,
            -1.374030178e+01f,  -1.357647354e+01f,  -1.359773614e+01f,  -1.343385310e+01f,  -1.361521666e+01f,  -1.345133998e+01f,
            -1.363269718e+01f,  -1.346882686e+01f,  -1.365017770e+01f,  -1.348631374e+01f,  -1.386337383e+01f,  -1.369897885e+01f,
            -1.422502796e+01f,  -1.405710243e+01f,  -1.406045922e+01f,  -1.389282162e+01f,  -1.407793974e+01f,  -1.391030850e+01f,
            -1.409542026e+01f,  -1.392779538e+01f,  -1.411290078e+01f,  -1.394528226e+01f,  -1.434833175e+01f,  -1.417984275e+01f,
            -1.492459321e+01f,  -1.475175324e+01f,  -1.479693431e+01f,  -1.462443998e+01f,  -1.482105746e+01f,  -1.464846290e+01f,
            -1.484518061e+01f,  -1.467248582e+01f,  -1.486930376e+01f,  -1.469650874e+01f,  -1.507242576e+01f,  -1.489864104e+01f,
            -2.020108150e+01f,  -1.997799576e+01f,  -2.010557303e+01f,  -1.988253824e+01f,  -2.013270128e+01f,  -1.990952864e+01f,
            -2.015982953e+01f,  -1.993651904e+01f,  -2.018695778e+01f,  -1.996350944e+01f,  -2.036097388e+01f,  -2.013682404e+01f,
            -2.054041345e+01f,  -2.031337731e+01f,  -2.038267448e+01f,  -2.015614376e+01f,  -2.040434468e+01f,  -2.017777016e+01f,
            -2.042601488e+01f,  -2.019939656e+01f,  -2.044768508e+01f,  -2.022102296e+01f,  -2.068125078e+01f,  -2.045349920e+01f,
            -2.104404798e+01f,  -2.081281760e+01f,  -2.086931672e+01f,  -2.063891000e+01f,  -2.089114532e+01f,  -2.066069480e+01f,
            -2.091297392e+01f,  -2.068247960e+01f,  -2.093480252e+01f,  -2.070426440e+01f,  -2.118595033e+01f,  -2.095400739e+01f,
            -2.177410294e+01f,  -2.153735016e+01f,  -2.164287293e+01f,  -2.140685384e+01f,  -2.167039718e+01f,  -2.143424024e+01f,
            -2.169792143e+01f,  -2.146162664e+01f,  -2.172544568e+01f,  -2.148901304e+01f,  -2.193656284e+01f,  -2.169875316e+01f,
            -4.360934940e+01f,  -4.317048844e+01f,  -4.334264207e+01f,  -4.290718856e+01f,  -4.337016632e+01f,  -4.293457496e+01f,
            -4.339769057e+01f,  -4.296196136e+01f,  -4.342521482e+01f,  -4.298934776e+01f,  -4.376398434e+01f,  -4.332401176e+01f,
            -4.370915175e+01f,  -4.327070749e+01f,  -4.331880728e+01f,  -4.288530680e+01f,  -4.334063588e+01f,  -4.290709160e+01f,
            -4.336246448e+01f,  -4.292887640e+01f,  -4.338429308e+01f,  -4.295066120e+01f,  -4.384158178e+01f,  -4.340235872e+01f,
            -4.419531850e+01f,  -4.375255328e+01f,  -4.378327352e+01f,  -4.334573864e+01f,  -4.380494372e+01f,  -4.336736504e+01f,
            -4.382661392e+01f,  -4.338899144e+01f,  -4.384828412e+01f,  -4.341061784e+01f,  -4.432750719e+01f,  -4.388396605e+01f,
            -4.513860636e+01f,  -4.468576156e+01f,  -4.482450197e+01f,  -4.437566816e+01f,  -4.485163022e+01f,  -4.440265856e+01f,
            -4.487875847e+01f,  -4.442964896e+01f,  -4.490588672e+01f,  -4.445663936e+01f,  -4.529273298e+01f,  -4.483878376e+01f,
            -5.008105101e+01f,  -4.957975461e+01f,  -4.971242669e+01f,  -4.921535174e+01f,  -4.973654984e+01f,  -4.923937466e+01f,
            -4.976067299e+01f,  -4.926339758e+01f,  -4.978479614e+01f,  -4.928742050e+01f,  -5.022771667e+01f,  -4.972546737e+01f,
            -5.004481974e+01f,  -4.954518982e+01f,  -4.951893358e+01f,  -4.902538846e+01f,  -4.953641410e+01f,  -4.904287534e+01f,
            -4.955389462e+01f,  -4.906036222e+01f,  -4.957137514e+01f,  -4.907784910e+01f,  -5.016765678e+01f,  -4.966746013e+01f,
            -5.052931090e+01f,  -5.002558371e+01f,  -4.998165666e+01f,  -4.948435698e+01f,  -4.999913718e+01f,  -4.950184386e+01f,
            -5.001661770e+01f,  -4.951933074e+01f,  -5.003409822e+01f,  -4.953681762e+01f,  -5.065284970e+01f,  -5.014855904e+01f,
            -5.161134477e+01f,  -5.109656354e+01f,  -5.119640111e+01f,  -5.068657022e+01f,  -5.122052426e+01f,  -5.071059314e+01f,
            -5.124464741e+01f,  -5.073461606e+01f,  -5.126877056e+01f,  -5.075863898e+01f,  -5.175976483e+01f,  -5.124403886e+01f,
            -5.705977942e+01f,  -5.649258552e+01f,  -5.672140703e+01f,  -5.615832704e+01f,  -5.674853528e+01f,  -5.618531744e+01f,
            -5.677566353e+01f,  -5.621230784e+01f,  -5.680279178e+01f,  -5.623929824e+01f,  -5.722257484e+01f,  -5.665431684e+01f,
            -5.708397601e+01f,  -5.651824899e+01f,  -5.660552888e+01f,  -5.604572456e+01f,  -5.662719908e+01f,  -5.606735096e+01f,
            -5.664886928e+01f,  -5.608897736e+01f,  -5.667053948e+01f,  -5.611060376e+01f,  -5.722916790e+01f,  -5.666272544e+01f,
            -5.759652702e+01f,  -5.702660576e+01f,  -5.710357592e+01f,  -5.653989560e+01f,  -5.712540452e+01f,  -5.656168040e+01f,
            -5.714723312e+01f,  -5.658346520e+01f,  -5.716906172e+01f,  -5.660525000e+01f,  -5.774319865e+01f,  -5.717256483e+01f,
            -5.865509206e+01f,  -5.807423112e+01f,  -5.828721893e+01f,  -5.771115464e+01f,  -5.831474318e+01f,  -5.773854104e+01f,
            -5.834226743e+01f,  -5.776592744e+01f,  -5.836979168e+01f,  -5.779331384e+01f,  -5.882149180e+01f,  -5.823957396e+01f,
        };

        float[] gw_expect = new float[] {
            -6.583085026e+01f,  -6.617854992e+01f,  -6.812306501e+01f,  -6.848140382e+01f,  -6.591922680e+01f,  -6.626767109e+01f,
            -6.749643691e+01f,  -6.785351014e+01f,  -6.927477086e+01f,  -6.963991286e+01f,  -6.758408482e+01f,  -6.794186167e+01f,
            -6.641631379e+01f,  -6.677023795e+01f,  -6.892981987e+01f,  -6.929495971e+01f,  -6.650731027e+01f,  -6.686198659e+01f,
            -6.859262395e+01f,  -6.895779617e+01f,  -7.035980107e+01f,  -7.073276198e+01f,  -6.868171243e+01f,  -6.904757964e+01f,
            -6.810133310e+01f,  -6.846619210e+01f,  -7.033588421e+01f,  -7.071038443e+01f,  -6.819314779e+01f,  -6.855873125e+01f,
            -7.317985714e+01f,  -7.358271348e+01f,  -7.505234069e+01f,  -7.546118678e+01f,  -7.326957288e+01f,  -7.367317385e+01f,
            -7.464341179e+01f,  -7.505336866e+01f,  -7.609372814e+01f,  -7.650813758e+01f,  -7.473199570e+01f,  -7.514265619e+01f,
            -7.387536979e+01f,  -7.428558715e+01f,  -7.591907587e+01f,  -7.633534291e+01f,  -7.396751827e+01f,  -7.437848779e+01f,
            -7.574429035e+01f,  -7.616234621e+01f,  -7.718124667e+01f,  -7.760347502e+01f,  -7.583405563e+01f,  -7.625280648e+01f,
            -7.546128686e+01f,  -7.588130254e+01f,  -7.727096597e+01f,  -7.769597347e+01f,  -7.555383595e+01f,  -7.597457609e+01f,
            -7.849536864e+01f,  -7.894128965e+01f,  -8.087411789e+01f,  -8.132688355e+01f,  -7.859294650e+01f,  -7.903963954e+01f,
            -8.022585658e+01f,  -8.067943794e+01f,  -8.206066445e+01f,  -8.251929674e+01f,  -8.032063968e+01f,  -8.077494482e+01f,
            -7.912200922e+01f,  -7.957533834e+01f,  -8.170360474e+01f,  -8.216381690e+01f,  -7.922321242e+01f,  -7.967732042e+01f,
            -8.135982470e+01f,  -8.182158200e+01f,  -8.316629952e+01f,  -8.363279190e+01f,  -8.145604090e+01f,  -8.191851045e+01f,
            -8.087691514e+01f,  -8.134042757e+01f,  -8.314750080e+01f,  -8.361666173e+01f,  -8.097787526e+01f,  -8.144213285e+01f,
            -8.609872082e+01f,  -8.659792283e+01f,  -8.794149444e+01f,  -8.844373325e+01f,  -8.619531502e+01f,  -8.669524943e+01f,
            -8.756278596e+01f,  -8.806767275e+01f,  -8.898272455e+01f,  -8.948975502e+01f,  -8.765663810e+01f,  -8.816221844e+01f,
            -8.684590992e+01f,  -8.735317324e+01f,  -8.883657000e+01f,  -8.934661088e+01f,  -8.694550608e+01f,  -8.745350612e+01f,
            -8.869177654e+01f,  -8.920468674e+01f,  -9.008554289e+01f,  -9.060035065e+01f,  -8.878668708e+01f,  -8.930028075e+01f,
            -8.845824170e+01f,  -8.897455297e+01f,  -9.020261508e+01f,  -9.072098707e+01f,  -8.855730550e+01f,  -8.907432565e+01f,
            -9.268430842e+01f,  -9.323391835e+01f,  -9.445535808e+01f,  -9.500551555e+01f,  -9.278607494e+01f,  -9.333642235e+01f,
            -9.412518662e+01f,  -9.467932098e+01f,  -9.548361600e+01f,  -9.603793168e+01f,  -9.422301562e+01f,  -9.477784686e+01f,
            -9.348295718e+01f,  -9.404131510e+01f,  -9.537862886e+01f,  -9.593696262e+01f,  -9.358819238e+01f,  -9.414729078e+01f,
            -9.527534496e+01f,  -9.583750318e+01f,  -9.659796019e+01f,  -9.716005302e+01f,  -9.537416006e+01f,  -9.593700366e+01f,
            -9.510367046e+01f,  -9.567051701e+01f,  -9.674906227e+01f,  -9.731542147e+01f,  -9.520769952e+01f,  -9.577525666e+01f,
            -1.002263069e+02f,  -1.008229029e+02f,  -1.014884217e+02f,  -1.020846124e+02f,  -1.003239968e+02f,  -1.009212683e+02f,
            -1.014045020e+02f,  -1.020049573e+02f,  -1.023735941e+02f,  -1.029735844e+02f,  -1.014990048e+02f,  -1.021001100e+02f,
            -1.011159857e+02f,  -1.017211071e+02f,  -1.024610921e+02f,  -1.030653368e+02f,  -1.012161982e+02f,  -1.018219949e+02f,
            -1.025375881e+02f,  -1.031458383e+02f,  -1.034785309e+02f,  -1.040861742e+02f,  -1.026327240e+02f,  -1.032416155e+02f,
            -1.025829646e+02f,  -1.031960102e+02f,  -1.037476896e+02f,  -1.043596546e+02f,  -1.026820547e+02f,  -1.032957557e+02f,
            -1.075869951e+02f,  -1.082387477e+02f,  -1.084235035e+02f,  -1.090702014e+02f,  -1.076839506e+02f,  -1.083363787e+02f,
            -1.085568452e+02f,  -1.092101841e+02f,  -1.091950397e+02f,  -1.098442975e+02f,  -1.086506712e+02f,  -1.093046601e+02f,
            -1.085761937e+02f,  -1.092376083e+02f,  -1.094503481e+02f,  -1.101057200e+02f,  -1.086752542e+02f,  -1.093373441e+02f,
            -1.096854990e+02f,  -1.103466329e+02f,  -1.102974882e+02f,  -1.109543989e+02f,  -1.097796989e+02f,  -1.104414740e+02f,
            -1.099333106e+02f,  -1.106015130e+02f,  -1.106769652e+02f,  -1.113394375e+02f,  -1.100310616e+02f,  -1.106999193e+02f,
        };
    }
}
