using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.Connection2D {
    [TestClass]
    public class ChannelwiseDeconvolutionTest {
        [TestMethod]
        public void ReferenceTest() {
            int channels = 7, kwidth = 3, kheight = 5, stride = 2, inwidth = 13, inheight = 17;
            int outwidth = inwidth - kwidth + 1, outheight = inheight - kheight + 1, batch = 2;

            float[] xval = (new float[inwidth * inheight * channels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] yval = (new float[outwidth * outheight * channels * batch]).Select((_, idx) => idx * 1e-3f).ToArray();
            float[] wval = (new float[kwidth * kheight * channels]).Select((_, idx) => idx * 1e-3f).Reverse().ToArray();

            Tensor xtensor = new Tensor(Shape.Map2D(channels, inwidth, inheight, batch), xval);
            Tensor ytensor = new Tensor(Shape.Map2D(channels, outwidth, outheight, batch), yval);
            Tensor wtensor = new Tensor(Shape.Kernel2D(channels, 1, kwidth, kheight), wval);

            VariableField x_actual = xtensor;
            ParameterField w = wtensor;
            ParameterField y = ytensor;

            Field x_expect = ChannelwiseDeconvolution2D(y, w, stride, Shape.Map2D(channels, inwidth, inheight, batch));
            Field err = Abs(x_expect - x_actual);
            OutputNode err_node = err.Value.Save();

            (Flow flow, Parameters Parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] err_actual = err_node.Tensor.State;
            float[] gy_actual = y.GradTensor.State;
            float[] gw_actual = w.GradTensor.State;

            AssertError.Tolerance(gw_expect, gw_actual, 1e-7f, 1e-5f, $"not equal gw");

            AssertError.Tolerance(gy_expect, gy_actual, 1e-7f, 1e-5f, $"not equal gy");
        }

        float[] gy_expect = new float[] {
            -9.6114305e-02f,  -9.4074965e-02f,  -9.2011523e-02f,  -8.9923763e-02f,  -8.7811469e-02f,  -8.5674425e-02f,  -8.3512415e-02f,
            -1.0630277e-01f,  -1.0407431e-01f,  -1.0182275e-01f,  -9.9547820e-02f,  -9.7249250e-02f,  -9.4926770e-02f,  -9.2580110e-02f,
            -1.1682272e-01f,  -1.1441860e-01f,  -1.1199074e-01f,  -1.0953889e-01f,  -1.0706276e-01f,  -1.0456210e-01f,  -1.0203662e-01f,
            -1.2734267e-01f,  -1.2476288e-01f,  -1.2215873e-01f,  -1.1952995e-01f,  -1.1687627e-01f,  -1.1419742e-01f,  -1.1149313e-01f,
            -1.3786262e-01f,  -1.3510717e-01f,  -1.3232672e-01f,  -1.2952102e-01f,  -1.2668978e-01f,  -1.2383274e-01f,  -1.2094964e-01f,
            -1.4991019e-01f,  -1.4694152e-01f,  -1.4394648e-01f,  -1.4092485e-01f,  -1.3787641e-01f,  -1.3480096e-01f,  -1.3169828e-01f,
            -2.4129770e-01f,  -2.3666120e-01f,  -2.3200010e-01f,  -2.2731411e-01f,  -2.2260295e-01f,  -2.1786632e-01f,  -2.1310394e-01f,
            -2.4995793e-01f,  -2.4517539e-01f,  -2.4036897e-01f,  -2.3553831e-01f,  -2.3068305e-01f,  -2.2580283e-01f,  -2.2089729e-01f,
            -2.6017569e-01f,  -2.5522893e-01f,  -2.5025745e-01f,  -2.4526089e-01f,  -2.4023889e-01f,  -2.3519109e-01f,  -2.3011713e-01f,
            -2.7039345e-01f,  -2.6528247e-01f,  -2.6014593e-01f,  -2.5498347e-01f,  -2.4979473e-01f,  -2.4457935e-01f,  -2.3933697e-01f,
            -2.8061121e-01f,  -2.7533601e-01f,  -2.7003441e-01f,  -2.6470605e-01f,  -2.5935057e-01f,  -2.5396761e-01f,  -2.4855681e-01f,
            -2.9390589e-01f,  -2.8838302e-01f,  -2.8283253e-01f,  -2.7725413e-01f,  -2.7164752e-01f,  -2.6601243e-01f,  -2.6034856e-01f,
            -3.8504035e-01f,  -3.7788911e-01f,  -3.7071008e-01f,  -3.6350295e-01f,  -3.5626741e-01f,  -3.4900314e-01f,  -3.4170983e-01f,
            -3.9206213e-01f,  -3.8482232e-01f,  -3.7755459e-01f,  -3.7025856e-01f,  -3.6293382e-01f,  -3.5558000e-01f,  -3.4819670e-01f,
            -4.0223575e-01f,  -3.9483554e-01f,  -3.8740650e-01f,  -3.7994824e-01f,  -3.7246037e-01f,  -3.6494250e-01f,  -3.5739424e-01f,
            -4.1240938e-01f,  -4.0484876e-01f,  -3.9725840e-01f,  -3.8963792e-01f,  -3.8198692e-01f,  -3.7430500e-01f,  -3.6659179e-01f,
            -4.2258300e-01f,  -4.1486198e-01f,  -4.0711031e-01f,  -3.9932760e-01f,  -3.9151346e-01f,  -3.8366750e-01f,  -3.7578933e-01f,
            -4.3745844e-01f,  -4.2943575e-01f,  -4.2138198e-01f,  -4.1329684e-01f,  -4.0518001e-01f,  -3.9703118e-01f,  -3.8885004e-01f,
            -5.2855699e-01f,  -5.1891381e-01f,  -5.0923847e-01f,  -4.9953066e-01f,  -4.8979007e-01f,  -4.8001638e-01f,  -4.7020929e-01f,
            -5.3395388e-01f,  -5.2428164e-01f,  -5.1457602e-01f,  -5.0483664e-01f,  -4.9506310e-01f,  -4.8525500e-01f,  -4.7541197e-01f,
            -5.4412750e-01f,  -5.3429486e-01f,  -5.2442793e-01f,  -5.1452632e-01f,  -5.0458964e-01f,  -4.9461750e-01f,  -4.8460951e-01f,
            -5.5430113e-01f,  -5.4430808e-01f,  -5.3427983e-01f,  -5.2421600e-01f,  -5.1411619e-01f,  -5.0398000e-01f,  -4.9380706e-01f,
            -5.6447475e-01f,  -5.5432130e-01f,  -5.4413174e-01f,  -5.3390568e-01f,  -5.2364273e-01f,  -5.1334250e-01f,  -5.0300460e-01f,
            -5.8097509e-01f,  -5.7046045e-01f,  -5.5991037e-01f,  -5.4932455e-01f,  -5.3870268e-01f,  -5.2804443e-01f,  -5.1734950e-01f,
            -6.7207364e-01f,  -6.5993851e-01f,  -6.4776686e-01f,  -6.3555837e-01f,  -6.2331273e-01f,  -6.1102963e-01f,  -5.9870875e-01f,
            -6.7584563e-01f,  -6.6374096e-01f,  -6.5159745e-01f,  -6.3941472e-01f,  -6.2719237e-01f,  -6.1493000e-01f,  -6.0262724e-01f,
            -6.8601925e-01f,  -6.7375418e-01f,  -6.6144936e-01f,  -6.4910440e-01f,  -6.3671891e-01f,  -6.2429250e-01f,  -6.1182478e-01f,
            -6.9619288e-01f,  -6.8376740e-01f,  -6.7130126e-01f,  -6.5879408e-01f,  -6.4624545e-01f,  -6.3365500e-01f,  -6.2102233e-01f,
            -7.0636650e-01f,  -6.9378062e-01f,  -6.8115317e-01f,  -6.6848376e-01f,  -6.5577200e-01f,  -6.4301750e-01f,  -6.3021987e-01f,
            -7.2449173e-01f,  -7.1148515e-01f,  -6.9843876e-01f,  -6.8535226e-01f,  -6.7222534e-01f,  -6.5905767e-01f,  -6.4584896e-01f,
            -8.1691912e-01f,  -8.0216718e-01f,  -7.8737584e-01f,  -7.7254484e-01f,  -7.5767388e-01f,  -7.4276266e-01f,  -7.2781092e-01f,
            -8.1962695e-01f,  -8.0493157e-01f,  -7.9019383e-01f,  -7.7541337e-01f,  -7.6058983e-01f,  -7.4572285e-01f,  -7.3081207e-01f,
            -8.2984471e-01f,  -8.1498511e-01f,  -8.0008231e-01f,  -7.8513595e-01f,  -7.7014567e-01f,  -7.5511111e-01f,  -7.4003191e-01f,
            -8.4006247e-01f,  -8.2503865e-01f,  -8.0997079e-01f,  -7.9485853e-01f,  -7.7970151e-01f,  -7.6449937e-01f,  -7.4925175e-01f,
            -8.5028023e-01f,  -8.3509219e-01f,  -8.1985927e-01f,  -8.0458111e-01f,  -7.8925735e-01f,  -7.7388763e-01f,  -7.5847159e-01f,
            -8.6986483e-01f,  -8.5422886e-01f,  -8.3855049e-01f,  -8.2282942e-01f,  -8.0706537e-01f,  -7.9125805e-01f,  -7.7540716e-01f,
            -9.7061571e-01f,  -9.5299916e-01f,  -9.3534372e-01f,  -9.1764918e-01f,  -8.9991532e-01f,  -8.8214193e-01f,  -8.6432879e-01f,
            -9.7476533e-01f,  -9.5716403e-01f,  -9.3952115e-01f,  -9.2183642e-01f,  -9.0410957e-01f,  -8.8634033e-01f,  -8.6852843e-01f,
            -9.8528528e-01f,  -9.6750832e-01f,  -9.4968914e-01f,  -9.3182749e-01f,  -9.1392308e-01f,  -8.9597566e-01f,  -8.7798494e-01f,
            -9.9580523e-01f,  -9.7785260e-01f,  -9.5985713e-01f,  -9.4181855e-01f,  -9.2373659e-01f,  -9.0561098e-01f,  -8.8744145e-01f,
            -1.0063252e+00f,  -9.8819689e-01f,  -9.7002512e-01f,  -9.5180962e-01f,  -9.3355010e-01f,  -9.1524631e-01f,  -8.9689796e-01f,
            -1.0252554e+00f,  -1.0067154e+00f,  -9.8813421e-01f,  -9.6951168e-01f,  -9.5084757e-01f,  -9.3214165e-01f,  -9.1339371e-01f,
            -1.3380822e+00f,  -1.3139915e+00f,  -1.2898555e+00f,  -1.2656741e+00f,  -1.2414469e+00f,  -1.2171739e+00f,  -1.1928547e+00f,
            -1.3393157e+00f,  -1.3153243e+00f,  -1.2912833e+00f,  -1.2671925e+00f,  -1.2430517e+00f,  -1.2188604e+00f,  -1.1946185e+00f,
            -1.3498356e+00f,  -1.3256686e+00f,  -1.3014513e+00f,  -1.2771836e+00f,  -1.2528652e+00f,  -1.2284957e+00f,  -1.2040750e+00f,
            -1.3603556e+00f,  -1.3360128e+00f,  -1.3116193e+00f,  -1.2871747e+00f,  -1.2626787e+00f,  -1.2381311e+00f,  -1.2135316e+00f,
            -1.3708755e+00f,  -1.3463571e+00f,  -1.3217873e+00f,  -1.2971657e+00f,  -1.2724922e+00f,  -1.2477664e+00f,  -1.2229881e+00f,
            -1.3910137e+00f,  -1.3659937e+00f,  -1.3409261e+00f,  -1.3158108e+00f,  -1.2906475e+00f,  -1.2654360e+00f,  -1.2401762e+00f,
            -1.4728094e+00f,  -1.4465061e+00f,  -1.4201500e+00f,  -1.3937408e+00f,  -1.3672782e+00f,  -1.3407619e+00f,  -1.3141916e+00f,
            -1.4702789e+00f,  -1.4442141e+00f,  -1.4180901e+00f,  -1.3919067e+00f,  -1.3656633e+00f,  -1.3393598e+00f,  -1.3129956e+00f,
            -1.4804966e+00f,  -1.4542676e+00f,  -1.4279786e+00f,  -1.4016293e+00f,  -1.3752192e+00f,  -1.3487480e+00f,  -1.3222154e+00f,
            -1.4907144e+00f,  -1.4643212e+00f,  -1.4378671e+00f,  -1.4113518e+00f,  -1.3847750e+00f,  -1.3581363e+00f,  -1.3314353e+00f,
            -1.5009321e+00f,  -1.4743747e+00f,  -1.4477556e+00f,  -1.4210744e+00f,  -1.3943309e+00f,  -1.3675245e+00f,  -1.3406551e+00f,
            -1.5250719e+00f,  -1.4978822e+00f,  -1.4706367e+00f,  -1.4433351e+00f,  -1.4159770e+00f,  -1.3885622e+00f,  -1.3610904e+00f,
            -1.6148819e+00f,  -1.5861920e+00f,  -1.5574438e+00f,  -1.5286369e+00f,  -1.4997710e+00f,  -1.4708459e+00f,  -1.4418611e+00f,
            -1.6105294e+00f,  -1.5821676e+00f,  -1.5537396e+00f,  -1.5252451e+00f,  -1.4966837e+00f,  -1.4680550e+00f,  -1.4393586e+00f,
            -1.6207030e+00f,  -1.5921808e+00f,  -1.5635915e+00f,  -1.5349348e+00f,  -1.5062103e+00f,  -1.4774175e+00f,  -1.4485561e+00f,
            -1.6308766e+00f,  -1.6021940e+00f,  -1.5734434e+00f,  -1.5446245e+00f,  -1.5157368e+00f,  -1.4867800e+00f,  -1.4577537e+00f,
            -1.6410503e+00f,  -1.6122072e+00f,  -1.5832953e+00f,  -1.5543142e+00f,  -1.5252634e+00f,  -1.4961425e+00f,  -1.4669512e+00f,
            -1.6673000e+00f,  -1.6377387e+00f,  -1.6081157e+00f,  -1.5784308e+00f,  -1.5486836e+00f,  -1.5188739e+00f,  -1.4890013e+00f,
            -1.7583985e+00f,  -1.7272167e+00f,  -1.6959722e+00f,  -1.6646646e+00f,  -1.6332937e+00f,  -1.6018591e+00f,  -1.5703605e+00f,
            -1.7524211e+00f,  -1.7216269e+00f,  -1.6907610e+00f,  -1.6598232e+00f,  -1.6288130e+00f,  -1.5977300e+00f,  -1.5665739e+00f,
            -1.7625947e+00f,  -1.7316401e+00f,  -1.7006129e+00f,  -1.6695129e+00f,  -1.6383395e+00f,  -1.6070925e+00f,  -1.5757714e+00f,
            -1.7727684e+00f,  -1.7416533e+00f,  -1.7104648e+00f,  -1.6792026e+00f,  -1.6478661e+00f,  -1.6164550e+00f,  -1.5849689e+00f,
            -1.7829420e+00f,  -1.7516665e+00f,  -1.7203168e+00f,  -1.6888922e+00f,  -1.6573926e+00f,  -1.6258175e+00f,  -1.5941665e+00f,
            -1.8108166e+00f,  -1.7787634e+00f,  -1.7466441e+00f,  -1.7144585e+00f,  -1.6822063e+00f,  -1.6498871e+00f,  -1.6175007e+00f,
            -1.9019152e+00f,  -1.8682414e+00f,  -1.8345006e+00f,  -1.8006923e+00f,  -1.7668164e+00f,  -1.7328724e+00f,  -1.6988600e+00f,
            -1.8943129e+00f,  -1.8610862e+00f,  -1.8277825e+00f,  -1.7944013e+00f,  -1.7609423e+00f,  -1.7274050e+00f,  -1.6937891e+00f,
            -1.9044865e+00f,  -1.8710994e+00f,  -1.8376344e+00f,  -1.8040910e+00f,  -1.7704688e+00f,  -1.7367675e+00f,  -1.7029867e+00f,
            -1.9146601e+00f,  -1.8811126e+00f,  -1.8474863e+00f,  -1.8137806e+00f,  -1.7799953e+00f,  -1.7461300e+00f,  -1.7121842e+00f,
            -1.9248338e+00f,  -1.8911259e+00f,  -1.8573382e+00f,  -1.8234703e+00f,  -1.7895219e+00f,  -1.7554925e+00f,  -1.7213818e+00f,
            -1.9543333e+00f,  -1.9197881e+00f,  -1.8851725e+00f,  -1.8504862e+00f,  -1.8157290e+00f,  -1.7809004e+00f,  -1.7460002e+00f,
            -2.0480851e+00f,  -2.0116664e+00f,  -1.9751800e+00f,  -1.9386258e+00f,  -1.9020034e+00f,  -1.8653125e+00f,  -1.8285528e+00f,
            -2.0399479e+00f,  -2.0039702e+00f,  -1.9679150e+00f,  -1.9317817e+00f,  -1.8955701e+00f,  -1.8592798e+00f,  -1.8229103e+00f,
            -2.0501656e+00f,  -2.0140238e+00f,  -1.9778035e+00f,  -1.9415043e+00f,  -1.9051259e+00f,  -1.8686680e+00f,  -1.8321302e+00f,
            -2.0603834e+00f,  -2.0240773e+00f,  -1.9876919e+00f,  -1.9512269e+00f,  -1.9146818e+00f,  -1.8780563e+00f,  -1.8413500e+00f,
            -2.0706011e+00f,  -2.0341309e+00f,  -1.9975804e+00f,  -1.9609495e+00f,  -1.9242376e+00f,  -1.8874445e+00f,  -1.8505699e+00f,
            -2.1013766e+00f,  -2.0640738e+00f,  -2.0267004e+00f,  -1.9892561e+00f,  -1.9517406e+00f,  -1.9141536e+00f,  -1.8764948e+00f,
            -2.2117192e+00f,  -2.1720513e+00f,  -2.1323233e+00f,  -2.0925351e+00f,  -2.0526864e+00f,  -2.0127770e+00f,  -1.9728067e+00f,
            -2.2077782e+00f,  -2.1684140e+00f,  -2.1289817e+00f,  -2.0894812e+00f,  -2.0499120e+00f,  -2.0102740e+00f,  -1.9705668e+00f,
            -2.2182982e+00f,  -2.1787583e+00f,  -2.1391497e+00f,  -2.0994722e+00f,  -2.0597255e+00f,  -2.0199093e+00f,  -1.9800234e+00f,
            -2.2288181e+00f,  -2.1891026e+00f,  -2.1493177e+00f,  -2.1094633e+00f,  -2.0695390e+00f,  -2.0295446e+00f,  -1.9894799e+00f,
            -2.2393381e+00f,  -2.1994469e+00f,  -2.1594857e+00f,  -2.1194543e+00f,  -2.0793525e+00f,  -2.0391800e+00f,  -1.9989364e+00f,
            -2.2672232e+00f,  -2.2266319e+00f,  -2.1859782e+00f,  -2.1452620e+00f,  -2.1044830e+00f,  -2.0636411e+00f,  -2.0227360e+00f,
        };

        float[] gw_expect = new float[] {
            -4.2519173e+01f,  -4.2687670e+01f,  -4.2856749e+01f,  -4.3026413e+01f,  -4.3196665e+01f,  -4.3367507e+01f,  -4.3538941e+01f,
            -4.3921439e+01f,  -4.4076880e+01f,  -4.4232715e+01f,  -4.4388946e+01f,  -4.4545574e+01f,  -4.4702601e+01f,  -4.4860027e+01f,
            -4.2915509e+01f,  -4.3085522e+01f,  -4.3256118e+01f,  -4.3427301e+01f,  -4.3599072e+01f,  -4.3771434e+01f,  -4.3944390e+01f,
            -4.5574516e+01f,  -4.5743109e+01f,  -4.5912171e+01f,  -4.6081704e+01f,  -4.6251710e+01f,  -4.6422190e+01f,  -4.6593147e+01f,
            -4.6593468e+01f,  -4.6752405e+01f,  -4.6911673e+01f,  -4.7071275e+01f,  -4.7231212e+01f,  -4.7391484e+01f,  -4.7552092e+01f,
            -4.5956458e+01f,  -4.6126456e+01f,  -4.6296924e+01f,  -4.6467864e+01f,  -4.6639278e+01f,  -4.6811166e+01f,  -4.6983532e+01f,
            -4.7039035e+01f,  -4.7225980e+01f,  -4.7413535e+01f,  -4.7601703e+01f,  -4.7790485e+01f,  -4.7979884e+01f,  -4.8169903e+01f,
            -4.8407182e+01f,  -4.8579627e+01f,  -4.8752481e+01f,  -4.8925746e+01f,  -4.9099422e+01f,  -4.9273512e+01f,  -4.9448017e+01f,
            -4.7441728e+01f,  -4.7630159e+01f,  -4.7819201e+01f,  -4.8008856e+01f,  -4.8199127e+01f,  -4.8390016e+01f,  -4.8581526e+01f,
            -5.0132444e+01f,  -5.0316880e+01f,  -5.0501788e+01f,  -5.0687168e+01f,  -5.0873023e+01f,  -5.1059354e+01f,  -5.1246163e+01f,
            -5.1098797e+01f,  -5.1273314e+01f,  -5.1448165e+01f,  -5.1623351e+01f,  -5.1798872e+01f,  -5.1974729e+01f,  -5.2150924e+01f,
            -5.0516326e+01f,  -5.0702132e+01f,  -5.0888411e+01f,  -5.1075162e+01f,  -5.1262390e+01f,  -5.1450094e+01f,  -5.1638277e+01f,
            -5.1866426e+01f,  -5.2067696e+01f,  -5.2269557e+01f,  -5.2472010e+01f,  -5.2675058e+01f,  -5.2878704e+01f,  -5.3082949e+01f,
            -5.3058646e+01f,  -5.3245836e+01f,  -5.3433425e+01f,  -5.3621413e+01f,  -5.3809803e+01f,  -5.3998595e+01f,  -5.4187791e+01f,
            -5.2267936e+01f,  -5.2470629e+01f,  -5.2673913e+01f,  -5.2877790e+01f,  -5.3082264e+01f,  -5.3287335e+01f,  -5.3493008e+01f,
        };
    }
}
