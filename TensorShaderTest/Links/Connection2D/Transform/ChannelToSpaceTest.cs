using System.Linq;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using TensorShader;
using static TensorShader.Field;

namespace TensorShaderTest.Links.Connection2D {
    [TestClass]
    public class ChannelToSpaceTest {
        [TestMethod]
        public void ReferenceTest() {
            int scale = 3;
            int outchannels = 2, inwidth = 4, inheight = 3, batch = 2;
            int inchannels = outchannels * scale * scale, outwidth = inwidth * scale, outheight = inheight * scale;

            float[] xval = (new float[inchannels * inwidth * inheight * batch]).Select((_, idx) => idx * 2e-3f).ToArray();
            float[] yval = (new float[outchannels * outwidth * outheight * batch]).Select((_, idx) => idx * 1e-3f).ToArray();

            Tensor xtensor = new Tensor(Shape.Map2D(inchannels, inwidth, inheight, batch), xval);
            Tensor ytensor = new Tensor(Shape.Map2D(outchannels, outwidth, outheight, batch), yval);

            ParameterField x = xtensor;
            VariableField y_actual = ytensor;

            Field y_expect = ChannelToSpace2D(x, scale);
            Field err = y_expect - y_actual;

            (Flow flow, Parameters Parameters) = Flow.Optimize(err);

            flow.Execute();

            float[] gx_actual = x.GradTensor.State;

            AssertError.Tolerance(gx_expect, gx_actual, 1e-7f, 1e-5f, $"not equal gx");
        }

        float[] gx_expect = {
            0.0000e+00f, 1.0000e-03f, 2.0000e-03f, 3.0000e-03f, 4.0000e-03f, 5.0000e-03f, -1.2000e-02f, -1.1000e-02f,
            -1.0000e-02f, -9.0000e-03f, -8.0000e-03f, -7.0000e-03f, -2.4000e-02f, -2.3000e-02f, -2.2000e-02f, -2.1000e-02f,
            -2.0000e-02f, -1.9000e-02f, 3.0000e-02f, 3.1000e-02f, 3.2000e-02f, 3.3000e-02f, 3.4000e-02f, 3.5000e-02f,
            1.8000e-02f, 1.9000e-02f, 2.0000e-02f, 2.1000e-02f, 2.2000e-02f, 2.3000e-02f, 6.0000e-03f, 7.0000e-03f,
            8.0000e-03f, 9.0000e-03f, 1.0000e-02f, 1.1000e-02f, 6.0000e-02f, 6.1000e-02f, 6.2000e-02f, 6.3000e-02f,
            6.4000e-02f, 6.5000e-02f, 4.8000e-02f, 4.9000e-02f, 5.0000e-02f, 5.1000e-02f, 5.2000e-02f, 5.3000e-02f,
            3.6000e-02f, 3.7000e-02f, 3.8000e-02f, 3.9000e-02f, 4.0000e-02f, 4.1000e-02f, 9.0000e-02f, 9.1000e-02f,
            9.2000e-02f, 9.3000e-02f, 9.4000e-02f, 9.5000e-02f, 7.8000e-02f, 7.9000e-02f, 8.0000e-02f, 8.1000e-02f,
            8.2000e-02f, 8.3000e-02f, 6.6000e-02f, 6.7000e-02f, 6.8000e-02f, 6.9000e-02f, 7.0000e-02f, 7.1000e-02f,
            7.2000e-02f, 7.3000e-02f, 7.4000e-02f, 7.5000e-02f, 7.6000e-02f, 7.7000e-02f, 6.0000e-02f, 6.1000e-02f,
            6.2000e-02f, 6.3000e-02f, 6.4000e-02f, 6.5000e-02f, 4.8000e-02f, 4.9000e-02f, 5.0000e-02f, 5.1000e-02f,
            5.2000e-02f, 5.3000e-02f, 1.0200e-01f, 1.0300e-01f, 1.0400e-01f, 1.0500e-01f, 1.0600e-01f, 1.0700e-01f,
            9.0000e-02f, 9.1000e-02f, 9.2000e-02f, 9.3000e-02f, 9.4000e-02f, 9.5000e-02f, 7.8000e-02f, 7.9000e-02f,
            8.0000e-02f, 8.1000e-02f, 8.2000e-02f, 8.3000e-02f, 1.3200e-01f, 1.3300e-01f, 1.3400e-01f, 1.3500e-01f,
            1.3600e-01f, 1.3700e-01f, 1.2000e-01f, 1.2100e-01f, 1.2200e-01f, 1.2300e-01f, 1.2400e-01f, 1.2500e-01f,
            1.0800e-01f, 1.0900e-01f, 1.1000e-01f, 1.1100e-01f, 1.1200e-01f, 1.1300e-01f, 1.6200e-01f, 1.6300e-01f,
            1.6400e-01f, 1.6500e-01f, 1.6600e-01f, 1.6700e-01f, 1.5000e-01f, 1.5100e-01f, 1.5200e-01f, 1.5300e-01f,
            1.5400e-01f, 1.5500e-01f, 1.3800e-01f, 1.3900e-01f, 1.4000e-01f, 1.4100e-01f, 1.4200e-01f, 1.4300e-01f,
            1.4400e-01f, 1.4500e-01f, 1.4600e-01f, 1.4700e-01f, 1.4800e-01f, 1.4900e-01f, 1.3200e-01f, 1.3300e-01f,
            1.3400e-01f, 1.3500e-01f, 1.3600e-01f, 1.3700e-01f, 1.2000e-01f, 1.2100e-01f, 1.2200e-01f, 1.2300e-01f,
            1.2400e-01f, 1.2500e-01f, 1.7400e-01f, 1.7500e-01f, 1.7600e-01f, 1.7700e-01f, 1.7800e-01f, 1.7900e-01f,
            1.6200e-01f, 1.6300e-01f, 1.6400e-01f, 1.6500e-01f, 1.6600e-01f, 1.6700e-01f, 1.5000e-01f, 1.5100e-01f,
            1.5200e-01f, 1.5300e-01f, 1.5400e-01f, 1.5500e-01f, 2.0400e-01f, 2.0500e-01f, 2.0600e-01f, 2.0700e-01f,
            2.0800e-01f, 2.0900e-01f, 1.9200e-01f, 1.9300e-01f, 1.9400e-01f, 1.9500e-01f, 1.9600e-01f, 1.9700e-01f,
            1.8000e-01f, 1.8100e-01f, 1.8200e-01f, 1.8300e-01f, 1.8400e-01f, 1.8500e-01f, 2.3400e-01f, 2.3500e-01f,
            2.3600e-01f, 2.3700e-01f, 2.3800e-01f, 2.3900e-01f, 2.2200e-01f, 2.2300e-01f, 2.2400e-01f, 2.2500e-01f,
            2.2600e-01f, 2.2700e-01f, 2.1000e-01f, 2.1100e-01f, 2.1200e-01f, 2.1300e-01f, 2.1400e-01f, 2.1500e-01f,
            2.1600e-01f, 2.1700e-01f, 2.1800e-01f, 2.1900e-01f, 2.2000e-01f, 2.2100e-01f, 2.0400e-01f, 2.0500e-01f,
            2.0600e-01f, 2.0700e-01f, 2.0800e-01f, 2.0900e-01f, 1.9200e-01f, 1.9300e-01f, 1.9400e-01f, 1.9500e-01f,
            1.9600e-01f, 1.9700e-01f, 2.4600e-01f, 2.4700e-01f, 2.4800e-01f, 2.4900e-01f, 2.5000e-01f, 2.5100e-01f,
            2.3400e-01f, 2.3500e-01f, 2.3600e-01f, 2.3700e-01f, 2.3800e-01f, 2.3900e-01f, 2.2200e-01f, 2.2300e-01f,
            2.2400e-01f, 2.2500e-01f, 2.2600e-01f, 2.2700e-01f, 2.7600e-01f, 2.7700e-01f, 2.7800e-01f, 2.7900e-01f,
            2.8000e-01f, 2.8100e-01f, 2.6400e-01f, 2.6500e-01f, 2.6600e-01f, 2.6700e-01f, 2.6800e-01f, 2.6900e-01f,
            2.5200e-01f, 2.5300e-01f, 2.5400e-01f, 2.5500e-01f, 2.5600e-01f, 2.5700e-01f, 3.0600e-01f, 3.0700e-01f,
            3.0800e-01f, 3.0900e-01f, 3.1000e-01f, 3.1100e-01f, 2.9400e-01f, 2.9500e-01f, 2.9600e-01f, 2.9700e-01f,
            2.9800e-01f, 2.9900e-01f, 2.8200e-01f, 2.8300e-01f, 2.8400e-01f, 2.8500e-01f, 2.8600e-01f, 2.8700e-01f,
            2.8800e-01f, 2.8900e-01f, 2.9000e-01f, 2.9100e-01f, 2.9200e-01f, 2.9300e-01f, 2.7600e-01f, 2.7700e-01f,
            2.7800e-01f, 2.7900e-01f, 2.8000e-01f, 2.8100e-01f, 2.6400e-01f, 2.6500e-01f, 2.6600e-01f, 2.6700e-01f,
            2.6800e-01f, 2.6900e-01f, 3.1800e-01f, 3.1900e-01f, 3.2000e-01f, 3.2100e-01f, 3.2200e-01f, 3.2300e-01f,
            3.0600e-01f, 3.0700e-01f, 3.0800e-01f, 3.0900e-01f, 3.1000e-01f, 3.1100e-01f, 2.9400e-01f, 2.9500e-01f,
            2.9600e-01f, 2.9700e-01f, 2.9800e-01f, 2.9900e-01f, 3.4800e-01f, 3.4900e-01f, 3.5000e-01f, 3.5100e-01f,
            3.5200e-01f, 3.5300e-01f, 3.3600e-01f, 3.3700e-01f, 3.3800e-01f, 3.3900e-01f, 3.4000e-01f, 3.4100e-01f,
            3.2400e-01f, 3.2500e-01f, 3.2600e-01f, 3.2700e-01f, 3.2800e-01f, 3.2900e-01f, 3.7800e-01f, 3.7900e-01f,
            3.8000e-01f, 3.8100e-01f, 3.8200e-01f, 3.8300e-01f, 3.6600e-01f, 3.6700e-01f, 3.6800e-01f, 3.6900e-01f,
            3.7000e-01f, 3.7100e-01f, 3.5400e-01f, 3.5500e-01f, 3.5600e-01f, 3.5700e-01f, 3.5800e-01f, 3.5900e-01f,
            3.6000e-01f, 3.6100e-01f, 3.6200e-01f, 3.6300e-01f, 3.6400e-01f, 3.6500e-01f, 3.4800e-01f, 3.4900e-01f,
            3.5000e-01f, 3.5100e-01f, 3.5200e-01f, 3.5300e-01f, 3.3600e-01f, 3.3700e-01f, 3.3800e-01f, 3.3900e-01f,
            3.4000e-01f, 3.4100e-01f, 3.9000e-01f, 3.9100e-01f, 3.9200e-01f, 3.9300e-01f, 3.9400e-01f, 3.9500e-01f,
            3.7800e-01f, 3.7900e-01f, 3.8000e-01f, 3.8100e-01f, 3.8200e-01f, 3.8300e-01f, 3.6600e-01f, 3.6700e-01f,
            3.6800e-01f, 3.6900e-01f, 3.7000e-01f, 3.7100e-01f, 4.2000e-01f, 4.2100e-01f, 4.2200e-01f, 4.2300e-01f,
            4.2400e-01f, 4.2500e-01f, 4.0800e-01f, 4.0900e-01f, 4.1000e-01f, 4.1100e-01f, 4.1200e-01f, 4.1300e-01f,
            3.9600e-01f, 3.9700e-01f, 3.9800e-01f, 3.9900e-01f, 4.0000e-01f, 4.0100e-01f, 4.5000e-01f, 4.5100e-01f,
            4.5200e-01f, 4.5300e-01f, 4.5400e-01f, 4.5500e-01f, 4.3800e-01f, 4.3900e-01f, 4.4000e-01f, 4.4100e-01f,
            4.4200e-01f, 4.4300e-01f, 4.2600e-01f, 4.2700e-01f, 4.2800e-01f, 4.2900e-01f, 4.3000e-01f, 4.3100e-01f,
        };
    }
}
